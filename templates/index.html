<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/datetimepicker/bootstrap-datetimepicker.min.css">
    <style>
        .td_active {
            background-color: purple;
        }

        #my_div {
            top: 215px !important;
        }
    </style>
    <link rel="icon" href="https://show.17sucai.com/preview/1424582/2020-11-30/zw/favicon.ico" type="image/ico">
    <link href="../static/css/style.css" rel="stylesheet">
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/css/theme.css" rel="stylesheet">
    <link href="../static/css/fonts.css" rel="stylesheet">
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.js"></script>
    <script src="../static/js/jquery.cookie.js"></script>
    <script src="../static/js/framework.js"></script>


</head>
<body class="theme-blue-gradient pace-done" style="overflow: hidden; ">
{#<div class="page-header">#}
{#  <h1 class="text-center">欢迎来到会议室预订系统</h1>#}
{#</div>#}
<div class="pace  pace-inactive">
    {#      <div class="pace-progress" style="width: 100%;" data-progress-text="100%" data-progress="99">#}
    {#        <div class="pace-progress-inner"></div>#}
    {#      </div>#}
    <div class="pace-activity"></div>
</div>
<div id="ajax-loader"
     style="background: rgb(255, 255, 255); left: -50%; top: -50%; width: 200%; height: 200%; overflow: hidden; display: none; position: fixed; z-index: 10000; cursor: progress;">
    <img style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto;" src="images/loader.gif">
</div>
<div id="theme-wrapper">
    <header class="navbar" id="header-navbar">
        <div class="container" style="padding-right: 0px;">
            <a class="navbar-brand" id="logo" href="http://127.0.0.1:8000/index/">Meeting System</a>
            <div class="clearfix">
                <div class="nav-no-collapse navbar-left pull-left hidden-sm hidden-xs">
                    <ul class="nav navbar-nav pull-left">
                        <li>
                            <a id="make-small-nav">
                                <div class="ftdms-aside-toggler">
                                    <span class="ftdms-toggler-bar"></span>
                                    <span class="ftdms-toggler-bar"></span>
                                    <span class="ftdms-toggler-bar"></span>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="nav-no-collapse pull-right" id="header-nav">
                    <ul class="nav navbar-nav pull-right">
                        <li class="dropdown profile-dropdown">
                            <a class="dropdown" href="#" data-toggle="dropdown">
                                <!-- <img class="img-qrcode img-qrcode-46" src="images/ftsucai.png" alt="用户头像" /> -->
                                <span class="hidden-xs">当前用户：{{ request.user.username }}&nbsp;&nbsp;&nbsp;&nbsp;</span></a>
                        <li>
                            <a class="submenuitem" href="pages_profile.html" data-id="rofile" data-index="100"><i
                                    class="ft ftsucai-58"></i>个人信息</a>
                        </li>
                        <li>
                            <a class="submenuitem" href="pages_edit_pwd.html" data-id="linkpwd" data-index="101"><i
                                    class="ft ftsucai-edit-2"></i>修改密码</a>
                        </li>
                        <li>
                            <a href="pages_login.html"><i class="ft ftsucai-exit2"></i>安全退出</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>
    <div class="container" id="page-wrapper">
        <div class="row">
            <div id="nav-col">
                <section class="col-left-nano" id="col-left">
                    <div class="col-left-nano-content" id="col-left-inner">
                        <div class="collapse navbar-collapse navbar-ex1-collapse" id="sidebar-nav">
                            <ul class="nav nav-pills nav-stacked">
                                <li>
                                    <a class="dropdown-toggle" href="#" data-id="a1">
                                        <i class="ft ftsucai-82"></i>
                                        <span>Dashboard</span>
                                        <i class="ft ftsucai-139 drop-icon"></i>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-toggle" href="#" data-id="a2">
                                        <i class="ft ftsucai-UI"></i>
                                        <span>Communication</span>
                                        <i class="ft ftsucai-139 drop-icon"></i>
                                    </a>
                                    <ul class="submenu">
                                        <li>
                                            <a class="submenuitem"
                                               href="tencent://message/?uin=3152609963&Site=QQ交谈&Menu=yes"
                                               data-id="link1" data-index="1">QQ</a>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <a class="dropdown-toggle" href="#" data-id="a3">
                                        <i class="ft ftsucai-edit-2"></i>
                                        <span>About</span>
                                        <i class="ft ftsucai-139 drop-icon"></i>
                                    </a>
                                    <ul class="submenu">
                                        <li>
                                            <a class="submenuitem" href="http://127.0.0.1:8000/about/" data-id="link21"
                                               data-index="21">Meet System</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>
            </div>
            <div id="content-wrapper">
                <div class="content-tabs" style="height:44px;border-bottom:2px solid #f0f0f0;">
                    <button class="roll-nav roll-left tabLeft">
                        <i class="ft ftsucai-backward2"></i>
                    </button>
                    <nav class="page-tabs menuTabs">
                        <div class="page-tabs-content" style="margin-left: 0px;">
                            <a class="menuTab active" href="javascript:;" data-id="home.html">Meeting System</a></div>
                    </nav>
                    <button class="roll-nav roll-right tabRight">
                        <i class="ft ftsucai-forward3"></i>
                    </button>
                    <div class="btn-group roll-nav roll-right">
                        <button class="dropdown tabClose" data-toggle="dropdown">页签操作
                            <i class="ft caret" style="padding-top: 3px;"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li>
                                <a class="tabReload" href="javascript:void();"><i class="ft ftsucai-spinner3"></i>刷新当前页面</a>
                            </li>
                            <li>
                                <a class="tabCloseCurrent" href="javascript:void();"><i class="ft ftsucai-close-3"></i>关闭当前页面</a>
                            </li>
                            <li>
                                <a class="tabCloseAll" href="javascript:void();"><i class="ft ftsucai-77"></i>关闭全部页面</a>
                            </li>
                            <li>
                                <a class="tabCloseOther" href="javascript:void();"><i class="ft ftsucai-120"></i>除此之外全关</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="content-iframe" style="background-color: #f9f9f9;">
                    <div class="mainContent" id="content-main" style="margin: 0px; padding: 0px; height: 1050px;">
                        <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                            <!-- Indicators -->
                            <ol class="carousel-indicators">
                                <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
                                <li data-target="#carousel-example-generic" data-slide-to="1"></li>
                                <li data-target="#carousel-example-generic" data-slide-to="2"></li>
                            </ol>
                        </div>

                        <div class="calender pull-right">
                            <div class='input-group' style="width: 230px;">
                                <span class="text-warning">注意：当前日期高亮显示</span>
                                <input type='text' autocomplete="off" class="form-control" id='datetimepicker11'
                                       placeholder="请选择日期"/>
                                <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-calendar">
                                            </span>
                                        </span>

                            </div>
                        </div>
                        <br>
                        <br>
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>会议室/时间</th>
                                {% for row in time_choice %}
                                    <th>{{ row.1 }}</th>
                                {% endfor %}
                            </tr>
                            </thead>
                            <tbody>
                            <!--由于模板语法功能不够强大，因此数据处理还是放在后台，在这里渲染后台传递来的标签字符串-->
                            {{ htmls|safe }}
                            </tbody>
                        </table>
                        <div>{% csrf_token %}</div>
                        <div class="col-lg-offset-6">
                            <button class="btn btn-info book_btn">预订</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="loadingPage" style="display: none;">
    <div class="loading-shade"></div>
    <div class="loading-content" onclick="$.loading(false)">数据加载中，请稍后…</div>
</div>


<div>
    {#    <!-- 固定导航栏 -->#}
    {#    <nav class="navbar navbar-default navbar-fixed-top" style="background: #475059">#}
    {#      <div class="container">#}
    {#        <div class="navbar-header">#}
    {#          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">#}
    {#            <span class="sr-only">Toggle navigation</span>#}
    {#            <span class="icon-bar"></span>#}
    {#            <span class="icon-bar"></span>#}
    {#            <span class="icon-bar"></span>#}
    {#          </button>#}
    {#          <a class="navbar-brand" href="/home/">会议室预订系统</a>#}
    {#        </div>#}
    {#        <div id="navbar" class="navbar-collapse collapse">#}
    {#          <ul class="nav navbar-nav">#}
    {#            <li class="active"><a href="/home/">Home</a></li>#}
    {#            <li><a href="/about/">About</a></li>#}
    {#            <li><a href="tencent://message/?uin=3152609963&Site=QQ交谈&Menu=yes" target="blank"><img border="0" src="../static/img/QQ.png" alt="图片不正常时显示的文字" width="24" height="24" /></a>#}
    {##}
    {#            </li>#}
    {#          </ul>#}
    {#            <ul class="nav navbar-nav navbar-right">#}
    {##}
    {#                <!--右上角个人中心-->#}
    {#                <div>#}
    {#                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">#}
    {##}
    {#                        <ul class="nav navbar-nav navbar-right">#}
    {#                            {% if request.user.username %}#}
    {#                                <li><a href="/index/">{{ request.user.username }}</a></li>#}
    {#                                <li class="dropdown">#}
    {#                                    <a href="#" class="dropdown-toggle " data-toggle="dropdown" role="button"#}
    {#                                       aria-haspopup="true"#}
    {#                                       aria-expanded="false">个人中心 <span class="caret"></span></a>#}
    {#                                    <ul class="dropdown-menu">#}
    {#                                        <li><a id="book" href="#" book_ret="{{ book_ret }}">预订信息</a></li>#}
    {#                                        <li class="text-lowercase text-center">#}
    {#                                            {% if book_ret %}#}
    {#                                                <span style="color: yellowgreen;margin-left: -55px"><a#}
    {#                                                        href="/index/">查看</a></span>#}
    {#                                            {% else %}#}
    {##}
    {#                                                <span class="text-center" style="color: yellowgreen;">暂无</span>#}
    {#                                            {% endif %}#}
    {#                                        </li>#}
    {#                                        <li role="separator" class="divider"></li>#}
    {#                                        <li><a href="/change_password/">修改密码</a></li>#}
    {#                                        <li><a href="/logout/">注销</a></li>#}
    {#                                    </ul>#}
    {#                                </li>#}
    {#                            {% else %}#}
    {#                                <li><a href="/login/">登录</a></li>#}
    {#                                <li><a href="/reg/">注册</a></li>#}
    {#                            {% endif %}#}
    {#                        </ul>#}
    {#                    </div>#}
    {#                </div>#}
    {#            </ul>#}
    {#        </div><!--/.nav-collapse -->#}
    {#      </div>#}
    {#    </nav>#}


    <script src="/static/js/jquery-3.3.1.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/datetimepicker/bootstrap-datetimepicker.min.js"></script>
    <script src="/static/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="../static/js/index.js"></script>
    <script src="../static/js/indextab.js"></script>
    <script src="../static/js/pace.min.js"></script>
    <script>

        // 日期格式化方法
        Date.prototype.yun = function (fmt) { //author:yun
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        };
        TODAY_DATE = new Date().yun("yyyy-MM-dd");//获取当前日期
        var POST_DATA = {
            "ADD": {},
            "DEL": {},
        };

        function TdClick() {
            $(".item").click(function () {
                var room_id = $(this).attr("room_id");
                var time_id = $(this).attr("time_id");

                //取消预订
                if ($(this).hasClass("info")) {
                    // 如果点击的标签具有info类，直接删除info类并清空内容
                    $(this).removeClass("info").empty();
                    if (POST_DATA.DEL[room_id]) {
                        // 在数据中已经存有会议室信息，将新单元格time_id添加进数组
                        POST_DATA.DEL[room_id].push(time_id);
                    } else
                        // 在数据中没有存过对应会议室记录，直接将time_id对其赋值创建一个字典
                    {
                        POST_DATA.DEL[room_id] = [time_id,];
                    }
                }
                //取消临时预订
                else if ($(this).hasClass("td_active")) {
                    $(this).removeClass("td_active");
                    //点击删除临时预订的数据
                    var index = $.inArray(time_id, POST_DATA.ADD[room_id]);
                    POST_DATA.ADD[room_id].splice(index, 1);

                }

                // 增加预订
                else {
                    $(this).addClass("td_active");
                    if (POST_DATA.ADD[room_id]) {
                        // 在数据中已经存有会议室信息，将新单元格time_id添加进数组
                        POST_DATA.ADD[room_id].push(time_id);
                    } else
                        // 在数据中没有存过对应会议室记录，直接将time_id对其赋值创建一个字典
                    {
                        POST_DATA.ADD[room_id] = [time_id,];
                    }
                    console.log(POST_DATA.ADD);
                }
            });
        };
        TdClick();

        // 日期

        if (location.search.slice(11)) {
            CHOOSE_DATE = location.search.slice(11)
        } else {
            CHOOSE_DATE = new Date().yun('yyyy-MM-dd');

        }
        // 通过ajax发送数据到后端
        $(".book_btn").click(function () {
            $.ajax({
                url: "/book/",
                type: "post",
                data: {
                    choose_date: CHOOSE_DATE,
                    csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                    post_data: JSON.stringify(POST_DATA),
                },
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    if (data.status == 1) {

                        alert("预订成功");
                        location.href = "";
                    } else if (data.status == 2) {
                        alert("未修改信息");
                        location.href = "";
                    } else {
                        alert("已经被预定")
                        location.href = ""
                    }
                },
            });
        });


        // 日历插件
        function book_query(e) {
            CHOOSE_DATE = e.date.yun("yyyy-MM-dd");
            location.href = "/index/?book_date=" + CHOOSE_DATE;
        };


        /**
         判断输入框中输入的日期格式为yyyy-mm-dd和正确的日期
         */
        function isDate(data) {
            var filter = /((^((1[8-9]\d{2})|([2-9]\d{3}))([-\/\._])(10|12|0?[13578])([-\/\._])(3[01]|[12][0-9]|0?[1-9])$)|(^((1[8-9]\d{2})|([2-9]\d{3}))([-\/\._])(11|0?[469])([-\/\._])(30|[12][0-9]|0?[1-9])$)|(^((1[8-9]\d{2})|([2-9]\d{3}))([-\/\._])(0?2)([-\/\._])(2[0-8]|1[0-9]|0?[1-9])$)|(^([2468][048]00)([-\/\._])(0?2)([-\/\._])(29)$)|(^([3579][26]00)([-\/\._])(0?2)([-\/\._])(29)$)|(^([1][89][0][48])([-\/\._])(0?2)([-\/\._])(29)$)|(^([2-9][0-9][0][48])([-\/\._])(0?2)([-\/\._])(29)$)|(^([1][89][2468][048])([-\/\._])(0?2)([-\/\._])(29)$)|(^([2-9][0-9][2468][048])([-\/\._])(0?2)([-\/\._])(29)$)|(^([1][89][13579][26])([-\/\._])(0?2)([-\/\._])(29)$)|(^([2-9][0-9][13579][26])([-\/\._])(0?2)([-\/\._])(29)$))/;
            if (filter.test(data)) {
                return true;
            } else {
                return false;
            }
        }

        $("#datetimepicker11").change(function () {
            var test = $(this).val();
            if (isDate(test)) {
                if (test < TODAY_DATE) {
                    alert("注意：日期不能小于当前日期!")
                }
                CHOOSE_DATE = test;
                location.href = "/index/?book_date=" + CHOOSE_DATE;
            } else {
                alert("日期格式错误！");
                location.href = '';
            }
        });
        //初始化日历
        $('#datetimepicker11').datetimepicker({
            minView: 2,
            startView: 2,
            language: "zh-CN",
            sideBySide: true,
            format: 'yyyy-mm-dd',
            startDate: TODAY_DATE,
            todayBtn: true,
            todayHighlight: 1,//当天日期高亮
            enterLikeTab: false,
            bootcssVer: 3,
            autoclose: true,
        }).on('changeDate', book_query).val(CHOOSE_DATE).css('font-weight', 'bold');
        $(".datetimepicker.datetimepicker-dropdown-bottom-right.dropdown-menu").attr("id", "my_div");

        var num = $("#book").attr("book_ret");
        if (num) {
            toastr.info('您目前有' + num + '个预订信息');
        } else {
            toastr.Warning('您目前没有预订信息');
        }
    </script>
</body>
</html>